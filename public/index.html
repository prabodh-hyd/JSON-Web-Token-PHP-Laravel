<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Authorization using JWTs and PHP</title>
  <!-- <link href="css/bootstrap.min.css" rel="stylesheet">
  <link href="css/signin.css" rel="stylesheet"> -->
</head>

<body>
  <main>
    <form method="post" action="./authenticate.php" id="frmLogin">
      <!--<h1 class="h3 mb-3 fw-normal">Log In</h1>

      <label for="inputEmail" class="visually-hidden" id="email">Email address</label>
      <input type="email" id="inputEmail" class="form-control" placeholder="Email address or username" required
        autofocus><br><br>

      <label for="inputPassword" class="visually-hidden" id="password">Password</label>
      <input type="password" id="inputPassword" class="form-control" placeholder="Password" required><br>

      <br><br>-->

      <button type="submit">Create a JWT Token</button>
    </form>

    <button id="btnGetResource">Get Current Timestamp</button>
    <span id="demo"></span>
    <!-- <form id="myForm">
      <label>Username:</label>
      <input type="text" id="inp1" name="username"><br>
      <button type="submit" onclick="submitForm(event)">Submit</button>
      </form> -->

    <form method="POST" action="./updateToken.php" id="updateBtn"><br>
      Name: <input type="text" id="updateString"><br><br>
      <button type="submit">Update Token</button>
    </form>

  </main>

  <script>
    const storeJWT = {};
    const loginBtn = document.querySelector('#frmLogin');
    const btnGetResource = document.querySelector('#btnGetResource');
    const btnUpdate = document.querySelector('#updateBtn');
    const formData = document.forms[0];

    // Inserts the jwt to the store object
    storeJWT.setJWT = function (data) {
      //console.log(data);
      this.JWT = data;
    };

    loginBtn.addEventListener('submit', async (e) => {
      e.preventDefault();
      const response = await fetch('./authenticate.php', {
        method: 'POST',
        headers: {
          'Content-type': 'application/x-www-form-urlencoded; charset=UTF-8'
        }
        /*body: JSON.stringify({
          username: formData.inputEmail.value,
          password: formData.inputPassword.value
        })*/
      });
      if (response.status >= 200 && response.status <= 299) {
        const jwt = await response.text();
        storeJWT.setJWT(jwt);
        frmLogin.style.display = 'none';
        btnGetResource.style.display = 'block';
      } else {
        // Handle errors
        console.log(response.status, response.statusText);
      }
    });

    // var myForm = document.getElementById("myForm");
    //   function submitForm(event) {
    //      event.preventDefault();
    //      alert(myForm.submit());
    //     //  result.innerHTML = "<b>The button is pressed and form is submitted.</b>"
    //   }

    btnUpdate.addEventListener('submit', async (e) => {
      e.preventDefault();
      const response = await fetch('./updateToken.php', {
        method: 'POST',
        headers: {
          'Content-type': 'application/x-www-form-urlencoded; charset=UTF-8'
        }
      })
    })

    btnGetResource.addEventListener('click', async (e) => {
      console.log(storeJWT.JWT);
      const res = await fetch('./resource.php', {
        headers: {
          'Authorization': `Bearer ${storeJWT.JWT}`
        }

      });
      const timeStamp = await res.text();
      let resTime = document.getElementById("demo").innerHTML = timeStamp;
      console.log(timeStamp);
      /*const result = setTimeout(() =>{
         document.getElementById("demo").innerHTML = "Token is Exp";
      }, 10000);*/

      /*if(time() > $expire_at)
     {
         console.log("expired.");
     }
     else{
         consol.log("valid");
     }*/

      /*if(!resTime){
        document.getElementById("demo").innerHTML = "Token is Exp...."
      }else{
        document.getElementById("demo").innerHTML = timeStamp;
      }*/

      /*let resTime = document.getElementById("demo").innerHTML = timeStamp;
      document.getElementById("demo").innerHTML = resTime;
      if(timeStamp){
         document.getElementById("demo").innerHTML = "Token is valid" +resTime;
       }else{
         document.getElementById("demo").innerHTML = "token is invalid";
       }*/
      //console.log(timeStamp);
      //      const expire_at = 60;
      //      function checkTokenExpiration(resTime, expire_at) {
      //   const currentTime = Math.floor(Date.now() / 1000);
      //   if (currentTime > expire_at) {
      //     //document.getElementById("demo").innerHTML = "token expired.."
      //     document.getElementById("demo").innerHTML = "token valid.."
      //     return false;
      //   } else {
      //     //document.getElementById("demo").innerHTML = "token is valid"
      //     document.getElementById("demo").innerHTML = "token expired.."
      //     return true;
      //   }
      // }
      // checkTokenExpiration(resTime, expire_at);

    });

  </script>
</body>

</html>